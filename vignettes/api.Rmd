---
title: "Complete Guide for Seven Bridges API R Client"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    number_sections: true
    theme: "flatly"
    highlight: "textmate"
    css: "sevenbridges.css"
vignette: >
  %\VignetteIndexEntry{Complete Guide for Seven Bridges API R Client}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<a name="top"></a>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```


`Important note:` This is a work-in-progress project to update the `sevenbridges` package. Accordingly, this vignette will also change as new features are implemented.

# Introduction

`sevenbridges2` is an R package that provides an interface for Seven Bridges public API. The supported platforms includes the [Seven Bridges Platform](https://igor.sbgenomics.com/), [Cancer Genomics Cloud (CGC)](https://www.cancergenomicscloud.org), and [Cavatica](https://cavatica.sbgenomics.com).

Learn more from our documentation on the [Seven Bridges Platform](https://docs.sevenbridges.com/page/api) and the [Cancer Genomics Cloud (CGC)](http://docs.cancergenomicscloud.org/v1.0/page/the-cgc-api).

Unlike the current `sevenbridges` package that is built on top of reference classes, the `sevenbridges2` package is based on more modern and lightweight R6 classes. However, the basic idea and way of constructing API requests is largely preserved.

## R Client for Seven Bridges API

The `sevenbridges2` package only supports v2+ versions of the API, since versions prior to V2 are not compatible with the Common Workflow Language (CWL). This package provides a simple interface for accessing and trying out various methods.

There are two ways of constructing API calls. For instance, you can use low-level API calls which use arguments like `path`, `query`, and `body`. These are documented in the API reference libraries for the [Seven Bridges Platform](https://docs.sevenbridges.com/reference#list-all-api-paths) and the [CGC](http://docs.cancergenomicscloud.org/docs/new-1). An example of a low-level request to "list all projects" is shown below. In this request, you can also pass `query` and `body` as a list.

```{r}
library("sevenbridges2")
a <- Auth$new(token = "your_token", platform = "aws-us")
a$api(path = "user", method = "GET")
```

***(Advanced user option)*** The second way of constructing an API request is to directly use the `httr` package to make your API calls, as shown below.

```{r}
a$user()
```

## API General Information

Before we start, keep in mind the following:

__`offset` and `limit`__

Every API call accepts two arguments named `offset` and `limit`.

- Offset defines where the retrieved items started.
- Limit defines the number of items you want to get.

By default, `offset` is set to `0` and `limit` is set to `100`. As such, your API request returns the __first 100 items__ when you list items or search for items by name. To search and list all items, use `complete = TRUE` in your API request.


__Search by ID__

When searching by ID, your request will return your exact resource as it is unique. As such, you do not have to set `offset` and `limit` manually. It is a good practice to find your resources by their ID and pass this ID as an input to your task. You can find a resource's ID in the final part of the URL on the visual interface or via the API requests to list resources or get a resource's details.

__Search by name__

Search by name returns all partial matches unless you specify `exact = TRUE`.

## Installation

The `sevenbridges2` package is currently only available on Seven Bridges internal GitLab repository.

To install it from `develop` branch, use:

```{r}
remotes::install_gitlab("r-stack/sevenbridges2@develop",
  auth_token = "${GIT_ACCESS_TOKEN}",
  host = "gitlab.sbgenomics.com",
  force = TRUE, upgrade = "never"
)
```

Where `GIT_ACCESS_TOKEN` is your personal access token for GitLab.


# Quickstart


## Create `Auth` Object

Before you can access your account via the API, you have to provide your credentials. You can obtain your credentials in the form of an ["authentication token"](https://docs.sevenbridges.com/v1.0/docs/get-your-authentication-token) from the **Developer Tab** under **Account Settings** on the visual interface. Once you've obtained this, create an `Auth` object, so it remembers your authentication token and the path for the API. All subsequent requests will draw upon these two pieces of information.

Let's load the package first:

```{r, eval = TRUE, message = FALSE}
library("sevenbridges2")
```

You have three different ways to provide your token. Choose from one method below:

1. [Direct authentication.](#method1) This explicitly and temporarily sets up your token and platform type (or alternatively, API base URL) in the function call arguments to `Auth()`.
2. [Authentication via system environment variables.](#method2) By default this will read the credential information from two system environment variables: `SB_API_ENDPOINT` and `SB_AUTH_TOKEN`. Alternatively, you can specify the names of the system environment variables you want to be loaded using the `sysenv_token` and `sysenv_url` arguments.
3. [Authentication via the user configuration file.](#method3) This file, by default `$HOME/.sevenbridges/credentials`, provides an organized way to collect and manage all your API authentication information for Seven Bridges platforms.


If you need to be logged into multiple accounts at the same time (which can also be for different platforms), please use either the second or third method.

<div style="margin-left:3em"><a name="method1"/>**Method 1: Direct authentication**

This is the most common method to construct the `Auth` object. For example:

```{r}
(a <- Auth$new(platform = "cgc", token = "your_token"))
```

<a name="method2"/>**Method 2: Environment variables**

To set the two environment variables in your system, you could use
the function `sbg_set_env()`. For example:

```{r}
sbg_set_env(url = "https://cgc-api.sbgenomics.com/v2", token = "your_token")
```

Note that this change might be just temporary, please feel free to
use the standard method to set persistent environment variables
according to your operating system.

Create an `Auth` object:

```{r}
a <- Auth$new(from = "env")
```

If you need to be logged into multiple accounts at the same time it is essential that you provide
environment variables for each of the accounts. Of course, these variables must have different names.

If you do not have pre-set environment variables, you can create them in the following way:

```{r}
# Set environment variables for the first account
sevenbridges2:::sbg_set_env(
  url = "https://cgc-api.sbgenomics.com/v2/",
  token = "<your_token_for_the_1st_account>",
  sysenv_url_name = "account_1_url",
  sysenv_token_name = "account_1_token"
)

# Set environment variables for the second account
sevenbridges2:::sbg_set_env(
  url = "https://cgc-api.sbgenomics.com/v2/",
  token = "<your_token_for_the_2nd_account>",
  sysenv_url_name = "account_2_url",
  sysenv_token_name = "account_2_token"
)
```

Now you are ready to create authentication object for these two accounts:

```{r}
a <- sevenbridges2::Auth$new(
  from = "env",
  sysenv_url = "account_1_url",
  sysenv_token = "account_1_token"
)

b <- sevenbridges2::Auth$new(
  from = "env",
  sysenv_url = "account_2_url",
  sysenv_token = "account_2_token"
)
```

<a name="method3"/>***Method 3: User configuration file***

Assume we have already created the configuration file named
`credentials` under the directory `$HOME/.sevenbridges/`:

```
[aws-us-rfranklin]
api_endpoint = https://api.sbgenomics.com/v2
auth_token = token_for_this_user

# This is a comment:
# another user on the same platform
[aws-us-rosalind-franklin]
api_endpoint = https://api.sbgenomics.com/v2
auth_token = token_for_this_user

[default]
api_endpoint = https://cgc-api.sbgenomics.com/v2
auth_token = token_for_this_user

[gcp]
api_endpoint = https://gcp-api.sbgenomics.com/v2
auth_token = token_for_this_user
```

To load the user profile `aws-us-rfranklin` from this configuration file, simply use:

```{r}
a <- sevenbridges2::Auth$new(from = "file", profile_name = "aws-us-rfranklin")
```

If `profile_name` is not specified, we will try to load the profile named `[default]`:

```{r}
a <- sevenbridges2::Auth$new(from = "file")
```


The option based on the use of a configuration file also enables simultaneous authentication from multiple accounts. 
Assuming that we have a configuration file like the one listed above, and that we want to create authentication objects for two profiles (**default** and **aws-us-rfranklin**), we can achieve this in the following way:

```{r}
a <- sevenbridges2::Auth$new(from = "file", profile_name = "default")
b <- sevenbridges2::Auth$new(from = "file", profile_name = "aws-us-rfranklin")
```


***Note:*** API paths (base URLs) differ for each Seven Bridges environment. Be sure to provide the correct path for the environment you are using. API paths for some of the environments are:

+-------------------------------------------+---------------------------------------------------+---------------+
| Platform Name                             | API Base URL                                      | Short Name    |
+===========================================+===================================================+===============+
| Seven Bridges Platform (US)               | `https://api.sbgenomics.com/v2`                   | `"aws-us"`    |
+-------------------------------------------+---------------------------------------------------+---------------+
| Seven Bridges Platform (EU)               | `https://eu-api.sbgenomics.com/v2`                | `"aws-eu"`    |
+-------------------------------------------+---------------------------------------------------+---------------+
| Seven Bridges Platform (China)            | `https://api.sevenbridges.cn/v2`                  | `"ali-cn"`    |
+-------------------------------------------+---------------------------------------------------+---------------+
| Cancer Genomics Cloud (CGC)               | `https://cgc-api.sbgenomics.com/v2`               | `"cgc"`       |
+-------------------------------------------+---------------------------------------------------+---------------+
| Cavatica                                  | `https://cavatica-api.sbgenomics.com/v2`          | `"cavatica"`  |
+-------------------------------------------+---------------------------------------------------+---------------+
| BioData Catalyst Powered by Seven Bridges | `https://api.sb.biodatacatalyst.nhlbi.nih.gov/v2` | `"f4c"`       |
+-------------------------------------------+---------------------------------------------------+---------------+


</div>

<div align="right"><a href="#top">top</a></div>


## Get User Information

<a name="youruser"/>**Get your own information**

This call returns information about your account.

```{r}
a$user()
```

```
── User ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• country: United States
• affiliation: SBG
• last_name: Franklin
• first_name: Rosalind
• email: rosalind.franklin@sbgenomics.com
• username: RFranklin
• href: https://cgc-api.sbgenomics.com/v2/users/RFranklin
```

<div align="right"><a href="#top">top</a></div>


**Get information about a user**

This call returns information about the specified user. Note that currently you can view only your own user information, so this call is equivalent to the [call to get information about your account](#youruser).

```{r}
a$user(username = "RFranklin")
```

<div align="right"><a href="#top">top</a></div>


## Rate Limit

This call returns information about your current rate limit. This is the number of API calls you can make in five minutes. This call also returns information about your current instance limit.

```{r}
a$rate_limit()
```

```
── Rate Limit ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• rate
  • limit: 1000
  • remaining: 1000
  • reset: 2022-12-26 11:31:01 CET
• instance
  • limit: 25
  • remaining: 25
```

<div align="right"><a href="#top">top</a></div>

## Show Billing Information

Each project must have a Billing Group associated with it. This Billing Group pays for the storage and computation in the project.

For example, your first project(s) were created with the free funds from the Pilot Funds Billing Group assigned to each user at sign-up.

To get a list of paths used to access billing information via the API:

``` {r}
# get paths used to access billing information
a$billing()
```

To get information about your billing groups:

```{r}
# check your billing info
a$billing_groups()
a$invoice()
```

This call lists all your billing groups, including groups that are pending or have been disabled.

To get information about your invoices:
```{r}
a$invoice()
```

The call returns information about all your available invoices, unless you use the \code{billing_group_id} query parameter to specify the ID of a particular billing group, in which case it will return the invoice incurred by that billing group only.

To get a detailed information for a specific billing group, please use the billing_group method with the billing group ID. The information returned includes the billing group owner, the total balance, and the status of the billing group (pending, disabled,...). 

```{r}
a$billing_groups(id = "<billing_group_id>")
```

```
── Billing group info ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• disabled: FALSE
• pending: FALSE
• type: regular
• name: My billing group
• owner: <bg_owner's_username>
• id: <billing_group_id>
• href: https://api.sbgenomics.com/v2/billing/groups/<billing_group_id>
• balance
  • currency: USD
  • amount: 221
```

Keep in mind that you can assign the output of the previous call to a variable, which will be an R6 environment:
```{r}
my_billing_group <- a$billing_groups(id = "<billing_group_id>")
# you can still print the billing group info by calling the print method
my_billing_group$print()
```

You can also get detailed information for a specific billing group,.The following options are available to you:
\itemize{
  \item analysis breakdown
  \item storage breakdown
  \item egress breakdown
}

To get an analysis breakdown for a billing group which contains information on both the tasks and Cruncher analysis, call:

```{r}
my_billing_group$analysis_breakdown()
```

To get a storage breakdown for a billing group, call:

```{r}
my_billing_group$storage_breakdown()
```

Finally, you may want to get an egress breakdown for a billing group:

```{r}
my_billing_group$egress_breakdown()
```


To retrieve information about a selected invoice, including the costs for analysis and storage, and the invoice period, you can use the invoice method with the id parameter set to the ID of the invoice you are querying.

```{r}
a$invoice(id = "<invoice_id>")
```

```
── Invoice info ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• approval_date: 2022-02-01T00:00:00Z
• pending: FALSE
• invoice_id: <your_invoice_id>
• href: https://api.sbgenomics.com/v2/billing/invoices/<your_invoice_id>
• invoice_period
  • from: 2022-01-01T00:00:00Z
  • to: 2022-01-31T23:59:59Z
• analysis_costs
  • currency: USD
  • amount: 101.77
• storage_costs
  • currency: USD
  • amount: 256.11
• total
  • currency: USD
  • amount: 357.88
```
<div align="right"><a href="#top">top</a></div>


## Create Project

Projects are the core building blocks of the platform. Each project corresponds to a distinct scientific investigation, serving as a container for its data, analysis tools, results, and collaborators.

Create a new project called "api testing" with the billing group `id` obtained above.

```{r}
# list all available billing groups for currently logged in user
a$billing_groups()
# set billing group for the new project
bid <- "<billing_group_id>"
# create new project
(p <- a$project_new(
  name = "api testing", billing_group = bid,
  description = "Just a test"
))
```

```
── Project ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• category: PRIVATE
• root_folder: <root_folder_id>
• type: v2
• description: Just a test
• billing_group: <billing_group_id>
• name: new project
• id: <your_username>/new-project
• href: https://api.sbgenomics.com/v2/projects/<your_username>/new-project
• settings
  • locked: FALSE
  • controlled: FALSE
  • location: aws:us-east-1
  • use_interruptible_instances: TRUE
  • use_memoization: FALSE
  • intermediate_files: list(duration = 24, retention = "LIMITED")
  • allow_network_access: TRUE
  • use_elastic_disk: FALSE
```

<div align="right"><a href="#top">top</a></div>

The **new project** is created on the platform. Notice also that the variable p is an R6 object with fields that contain information about the platform project. The facility also has several methods that allow you to perform basic platform operations on the project.


## Get Details about Existing Project

```{r}
# list first 50 projects
a$projects()
# list all
a$projects(complete = TRUE) # CHECK WHY THIS DOESN'T WORK!
# return all named match "demo"
a$projects(name = "demo")
# return all projects tagged with "test_tags"
a$projects(query = list(tags = c("test_tags")))
```

## Get Details of a Specified Project

```{r}
a$project_get(project_owner = "luna_lovegood", project = "nargles-project")
```

```
── Project ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• category: PRIVATE
• modified_on: 2022-12-20T16:09:20Z
• created_on: 2022-12-20T16:09:20Z
• created_by: luna_lovegood
• root_folder: 12a1ab12345a12345a12345a
• type: v2
• billing_group: ab12345a-123a-1234-1234-a1ab12a12ab1
• name: nargles-project
• id: luna_lovegood/nargles-project
• href: https://api.sbgenomics.com/v2/projects/luna_lovegood/nargles-project
• settings
  • locked: FALSE
  • controlled: FALSE
  • location: aws:us-east-1
  • use_interruptible_instances: TRUE
  • use_memoization: FALSE
  • intermediate_files: list(duration = 24, retention = "LIMITED")
  • allow_network_access: FALSE
  • use_elastic_disk: FALSE
• permissions
  • write: TRUE
  • read: TRUE
  • copy: TRUE
  • execute: TRUE
  • admin: TRUE
```

## Create a New Project

```{r}
a$project_new(
  name = "api_created_project",
  billing_group = "<your_billing_group_id>",
  description = "This project has been created using the
              sevenbridges2 R API library."
)
```

```
── Project ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
• category: PRIVATE
• root_folder: 12a123ab1234a12a1ab1234a
• type: v2
• description: This project has been created using the sevenbridges2 R 
API library.
• billing_group: <your_billing_group_id>
• name: api_created_project
• id: <owner>/api-created-project
• href: https://cgc-api.sbgenomics.com/v2/projects/<owner>/api-created-project
• settings
  • locked: FALSE
  • controlled: FALSE
  • location: aws:us-east-1
  • use_interruptible_instances: TRUE
  • use_memoization: FALSE
  • intermediate_files: list(duration = 24, retention = "LIMITED")
  • allow_network_access: FALSE
  • use_elastic_disk: FALSE
```

## Edit an existing project

If for some reason you want to edit an existing project, you can do so by using
the **edit** method on the Project class object. As a project Admin you can use
it to change the name, settings, tags or billing group of the project. For 
example, if you want to change the name and description of the project, you can
do it in the following way:

```{r}
p <- a$project_get(
  project_owner = "<your_username>",
  project = "<project's-short-name>"
)
p$edit(
  name = "project_with_modified_name",
  description = "This is the modified description."
)
```

Keep in mind that this modifies only the name of the project, not its short 
name. Therefore, after calling this method, the id of the project will remain 
the same \code{your_username/project's-short-name}.


## Delete a project

You may also want to delete some project from the Platform using through the R 
client library. To do that, you need to call the \code{delete} method on the 
project object:

```{r}
p <- a$project_get(
  project_owner = "<your_username>",
  project = "<project's-short-name>"
)
p$delete()
```

Please be careful when using this method and note that calling it will
permanently delete the project from the platform.


## List project members

To get a list of the members of the specified project:

```{r}
p$member_list()
```


## Add a member to a project

To add a new user to a specified project:

```{r}
p <- a$project_get(
  project_owner = "<your_username>",
  project = "<project's-short-name>"
)
p$member_add(username = "<username_of_a_user_you_want_to_add>")
```


Please keep in mind that this call can only be successfully made by a user who 
has admin permissions in the project.


## Remove a project member

On the other hand, you can delete a member from the project in a similar way:

```{r}
p$member_delete("<username_of_a_user_you_want_to_remove>")
```


## Get a project member's permissions

Sometimes you may just want to investigate a members's permissions within a 
specified project, and you can do that by calling:

```{r}
p$member_permissions_get(username = "<username_of_a_user_of_interest>")
```


## Modify a project member's permissions

To modify a project member's permissions you can use the \code{
member_permissions_modify} method. For this method to work, the user calling it 
must have admin permissions in the project. For example, you may want to give 
admin permissions to a project member:

```{r}
p$member_permissions_modify(
  username = "username_of_the_member_whose_permissions_you_are_editing",
  admin = TRUE
)
```
